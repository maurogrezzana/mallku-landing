---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import WhatsAppFloat from '../components/WhatsAppFloat.astro';
---

<BaseLayout
  title="Reservar excursión"
  description="Completá tu reserva online para una excursión arqueológica con Mallku. Confirmación inmediata, grupos reducidos."
>
  <WhatsAppFloat />
  <Header />

  <main>
    <section class="reservar-hero">
      <div class="wrap">
        <nav class="breadcrumb" aria-label="Navegación">
          <a href="/">Inicio</a> <span>›</span>
          <a href="/calendario">Calendario</a> <span>›</span>
          <span>Reservar</span>
        </nav>
        <h1>Completá tu <span class="accent">Reserva</span></h1>
        <p class="hero-lead">Revisá los detalles y completá tus datos para asegurar tu lugar.</p>
      </div>
    </section>

    <section class="section section-light">
      <div class="wrap reservar-layout">

        <!-- Cargando estado -->
        <div id="loading-state" class="loading-block">
          <div class="loading-spinner"></div>
          <p>Cargando información de la fecha...</p>
        </div>

        <!-- Error estado -->
        <div id="error-state" class="error-block" style="display:none">
          <p class="error-msg" id="error-msg">No se pudo cargar la fecha seleccionada.</p>
          <a href="/calendario" class="btn btn-primary">Ver calendario</a>
        </div>

        <!-- Contenido principal -->
        <div id="main-content" style="display:none">
          <!-- Panel izquierdo: resumen de la fecha -->
          <div class="resumen-panel">
            <div class="resumen-card">
              <div class="resumen-excursion" id="resumen-excursion">—</div>
              <div class="resumen-fecha-wrap">
                <span class="resumen-dia" id="resumen-dia">—</span>
                <span class="resumen-mes" id="resumen-mes">—</span>
              </div>
              <div class="resumen-detalles">
                <div class="resumen-item">
                  <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                  <span><strong id="resumen-cupos">—</strong> cupos disponibles</span>
                </div>
                <div class="resumen-item">
                  <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                  <span id="resumen-hora">—</span>
                </div>
              </div>

              <div class="resumen-estado" id="resumen-estado-wrap" style="display:none">
                <span class="estado-badge pocos-cupos" id="resumen-estado-badge">¡Pocos cupos!</span>
              </div>

              <div class="precio-wrap">
                <span class="precio-label">Precio por persona</span>
                <span class="precio-valor" id="resumen-precio">—</span>
              </div>
            </div>

            <div class="info-pago">
              <h4>¿Cómo funciona?</h4>
              <ul>
                <li>Completá el formulario y recibís confirmación por email</li>
                <li>Se requiere una seña del 30-50% para asegurar el lugar</li>
                <li>El saldo se abona 48hs antes de la salida</li>
                <li>Podés reprogramar con 7 días de anticipación sin cargo</li>
              </ul>
            </div>
          </div>

          <!-- Panel derecho: formulario -->
          <div class="form-panel">
            <form id="booking-form" novalidate>
              <h3>Tus datos</h3>

              <div class="form-group">
                <label for="nombre">Nombre completo <span class="required">*</span></label>
                <input type="text" id="nombre" name="nombre" placeholder="Ej: María González" required autocomplete="name" />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="email">Email <span class="required">*</span></label>
                  <input type="email" id="email" name="email" placeholder="tu@email.com" required autocomplete="email" />
                </div>
                <div class="form-group">
                  <label for="telefono">Teléfono / WhatsApp <span class="required">*</span></label>
                  <input type="tel" id="telefono" name="telefono" placeholder="Ej: +54 381 555-0000" required autocomplete="tel" />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="dni">DNI</label>
                  <input type="text" id="dni" name="dni" placeholder="Opcional" />
                </div>
                <div class="form-group">
                  <label for="cantidadPersonas">Cantidad de personas <span class="required">*</span></label>
                  <select id="cantidadPersonas" name="cantidadPersonas" required>
                    <option value="">— Seleccioná —</option>
                    <option value="1">1 persona</option>
                    <option value="2">2 personas</option>
                    <option value="3">3 personas</option>
                    <option value="4">4 personas</option>
                    <option value="5">5 personas</option>
                    <option value="6">6 personas</option>
                    <option value="7">7 personas</option>
                    <option value="8">8 personas</option>
                  </select>
                </div>
              </div>

              <div class="form-group">
                <label for="notasCliente">Consultas o comentarios</label>
                <textarea id="notasCliente" name="notasCliente" rows="3" placeholder="Ej: Somos un grupo mixto, hay personas mayores. ¿Hay acceso con dificultad reducida?"></textarea>
              </div>

              <div id="form-error" class="form-error" style="display:none" role="alert" aria-live="polite"></div>

              <button type="submit" class="btn btn-primary btn-full" id="submit-btn">
                Confirmar reserva
              </button>

              <p class="form-privacidad">
                Tus datos se usan solo para gestionar tu reserva y comunicarnos con vos.
                <a href="/politica-de-privacidad">Política de privacidad</a>.
              </p>
            </form>
          </div>
        </div>

      </div>
    </section>
  </main>

  <Footer />
</BaseLayout>

<script>
  const API_URL = 'https://mallku-api.vercel.app';

  // Get dateId from URL params
  const params = new URLSearchParams(window.location.search);
  const dateId = params.get('dateId');

  const loadingEl = document.getElementById('loading-state') as HTMLElement;
  const errorEl = document.getElementById('error-state') as HTMLElement;
  const mainEl = document.getElementById('main-content') as HTMLElement;
  const errorMsg = document.getElementById('error-msg') as HTMLElement;

  function showError(msg: string) {
    loadingEl.style.display = 'none';
    errorEl.style.display = 'flex';
    if (errorMsg) errorMsg.textContent = msg;
  }

  function showMain() {
    loadingEl.style.display = 'none';
    mainEl.style.display = 'grid';
  }

  async function loadDate() {
    if (!dateId) {
      showError('No se especificó ninguna fecha. Volvé al calendario y elegí una fecha disponible.');
      return;
    }

    try {
      const res = await fetch(`${API_URL}/api/v1/dates/${dateId}`);
      if (!res.ok) {
        showError('La fecha seleccionada no está disponible. Por favor elegí otra.');
        return;
      }
      const json = await res.json();
      if (!json.success || !json.data) {
        showError('No se pudo cargar la información de la fecha.');
        return;
      }

      const date = json.data;

      if (date.estado === 'completo') {
        showError('Esta fecha ya no tiene cupos disponibles. Por favor elegí otra fecha en el calendario.');
        return;
      }

      // Populate summary
      const fechaObj = new Date(date.fecha);
      const dia = fechaObj.getDate();
      const mes = fechaObj.toLocaleDateString('es-AR', { weekday: 'long', month: 'long', year: 'numeric' });

      document.getElementById('resumen-excursion')!.textContent = date.excursionTitulo;
      document.getElementById('resumen-dia')!.textContent = String(dia);
      document.getElementById('resumen-mes')!.textContent = mes;
      document.getElementById('resumen-cupos')!.textContent = String(date.cuposDisponibles);
      document.getElementById('resumen-hora')!.textContent = date.horaSalida
        ? `Salida: ${date.horaSalida}hs`
        : 'Consultar horario de salida';

      const precio = date.precioOverride || date.precioBase;
      document.getElementById('resumen-precio')!.textContent = precio
        ? `$${Math.round(precio / 100).toLocaleString('es-AR')}`
        : 'Consultar precio';

      if (date.estado === 'pocos-cupos') {
        const estadoWrap = document.getElementById('resumen-estado-wrap') as HTMLElement;
        estadoWrap.style.display = 'block';
      }

      // Cap cantidadPersonas select at cuposDisponibles
      const select = document.getElementById('cantidadPersonas') as HTMLSelectElement;
      const maxCupos = Math.min(date.cuposDisponibles, 8);
      for (let i = select.options.length - 1; i >= 1; i--) {
        if (parseInt(select.options[i].value) > maxCupos) {
          select.remove(i);
        }
      }

      showMain();

      // Store dateId for form submission
      (document.getElementById('booking-form') as HTMLElement).dataset.dateId = dateId!;

    } catch {
      showError('Error de conexión. Por favor intentá nuevamente o consultanos por WhatsApp.');
    }
  }

  // Form submission
  const form = document.getElementById('booking-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const formError = document.getElementById('form-error') as HTMLElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    formError.style.display = 'none';
    submitBtn.disabled = true;
    submitBtn.textContent = 'Enviando...';

    const formData = new FormData(form);
    const storedDateId = form.dataset.dateId;

    const body = {
      tipo: 'fecha-fija',
      dateId: storedDateId,
      nombreCompleto: formData.get('nombre') as string,
      email: formData.get('email') as string,
      telefono: formData.get('telefono') as string,
      dni: formData.get('dni') as string || undefined,
      cantidadPersonas: parseInt(formData.get('cantidadPersonas') as string),
      notasCliente: formData.get('notasCliente') as string || undefined,
    };

    // Basic validation
    if (!body.nombreCompleto || !body.email || !body.telefono || !body.cantidadPersonas) {
      formError.textContent = 'Por favor completá todos los campos requeridos.';
      formError.style.display = 'block';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Confirmar reserva';
      return;
    }

    try {
      const res = await fetch(`${API_URL}/api/v1/bookings`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      const json = await res.json();

      if (!res.ok || !json.success) {
        const msg = json.message || 'No se pudo completar la reserva. Intentá nuevamente.';
        formError.textContent = msg;
        formError.style.display = 'block';
        formError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        submitBtn.disabled = false;
        submitBtn.textContent = 'Confirmar reserva';
        return;
      }

      // Redirect to confirmation page
      window.location.href = `/reservas?numero=${encodeURIComponent(json.data.bookingNumber)}`;

    } catch {
      formError.textContent = 'Error de conexión. Por favor intentá nuevamente o consultanos por WhatsApp.';
      formError.style.display = 'block';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Confirmar reserva';
    }
  });

  loadDate();
</script>

<style>
  .reservar-hero {
    padding: 60px 0 40px;
    background:
      radial-gradient(ellipse 80% 50% at 50% 0%, rgba(209, 107, 56, 0.12), transparent),
      var(--color-bg-dark);
  }

  .breadcrumb {
    font-size: 13px;
    color: rgba(239, 227, 214, 0.6);
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
  }

  .breadcrumb a {
    color: rgba(239, 227, 214, 0.6);
    text-decoration: none;
  }

  .breadcrumb a:hover {
    color: var(--beige);
  }

  .reservar-hero h1 {
    margin: 0 0 12px;
    font-size: clamp(32px, 5vw, 48px);
  }

  .accent {
    color: var(--terracota);
  }

  .hero-lead {
    color: rgba(239, 227, 214, 0.75);
    font-size: 17px;
    margin: 0;
  }

  /* Layout */
  .reservar-layout {
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: var(--space-xl);
    align-items: start;
    padding-top: var(--space-xl);
    padding-bottom: var(--space-2xl);
  }

  /* Loading */
  .loading-block {
    grid-column: 1 / -1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    padding: var(--space-2xl) 0;
    color: var(--marron);
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(209, 107, 56, 0.2);
    border-top-color: var(--terracota);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Error */
  .error-block {
    grid-column: 1 / -1;
    flex-direction: column;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-2xl) 0;
    text-align: center;
  }

  .error-msg {
    color: var(--marron);
    font-size: 17px;
    max-width: 50ch;
  }

  /* Resumen card */
  .resumen-card {
    background: var(--azul);
    border: 1px solid var(--color-line-light);
    padding: var(--space-lg);
    color: var(--beige);
  }

  .resumen-excursion {
    font-family: var(--font-display);
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--terracota);
    margin-bottom: 12px;
  }

  .resumen-fecha-wrap {
    margin-bottom: 20px;
  }

  .resumen-dia {
    font-family: var(--font-heading);
    font-size: 56px;
    font-weight: 700;
    line-height: 1;
    color: var(--beige);
    display: block;
  }

  .resumen-mes {
    font-size: 14px;
    color: rgba(239, 227, 214, 0.7);
    text-transform: capitalize;
    display: block;
    margin-top: 4px;
  }

  .resumen-detalles {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 16px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--color-line-light);
  }

  .resumen-item {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    color: rgba(239, 227, 214, 0.8);
  }

  .resumen-item svg {
    width: 18px;
    height: 18px;
    fill: var(--terracota);
    flex-shrink: 0;
  }

  .resumen-estado {
    margin-bottom: 16px;
  }

  .estado-badge {
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    font-family: var(--font-display);
  }

  .estado-badge.pocos-cupos {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
  }

  .precio-wrap {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--color-line-light);
  }

  .precio-label {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: rgba(239, 227, 214, 0.5);
  }

  .precio-valor {
    font-family: var(--font-heading);
    font-size: 28px;
    font-weight: 700;
    color: var(--terracota);
  }

  /* Info pago */
  .info-pago {
    margin-top: var(--space-md);
    background: rgba(209, 107, 56, 0.06);
    border-left: 3px solid var(--terracota);
    padding: 16px 20px;
  }

  .info-pago h4 {
    margin: 0 0 10px;
    font-size: 13px;
    color: var(--azul);
    letter-spacing: 0.5px;
  }

  .info-pago ul {
    margin: 0;
    padding-left: 16px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .info-pago li {
    font-size: 13px;
    color: var(--marron);
    line-height: 1.4;
  }

  /* Form */
  .form-panel {
    background: #fff;
    padding: var(--space-xl);
    border: 1px solid rgba(86, 46, 24, 0.12);
  }

  .form-panel h3 {
    margin: 0 0 var(--space-lg);
    color: var(--azul);
    font-size: 22px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: var(--space-md);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-md);
  }

  label {
    font-size: 13px;
    font-family: var(--font-display);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--azul);
  }

  .required {
    color: var(--terracota);
  }

  input, select, textarea {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid rgba(86, 46, 24, 0.25);
    border-radius: 0;
    font-family: var(--font-body);
    font-size: 15px;
    color: var(--azul);
    background: #fff;
    transition: border-color 0.2s ease;
    -webkit-appearance: none;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--terracota);
  }

  textarea {
    resize: vertical;
    min-height: 90px;
  }

  .form-error {
    background: rgba(220, 38, 38, 0.08);
    border: 1px solid rgba(220, 38, 38, 0.3);
    color: #dc2626;
    padding: 12px 16px;
    font-size: 14px;
    margin-bottom: var(--space-md);
  }

  .form-privacidad {
    font-size: 12px;
    color: rgba(86, 46, 24, 0.6);
    margin-top: var(--space-md);
    text-align: center;
  }

  .form-privacidad a {
    color: var(--terracota);
    text-decoration: underline;
  }

  @media (max-width: 900px) {
    .reservar-layout {
      grid-template-columns: 1fr;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .resumen-card {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-md);
    }

    .resumen-detalles {
      border-bottom: none;
    }
  }

  @media (max-width: 600px) {
    .resumen-card {
      grid-template-columns: 1fr;
    }

    .form-panel {
      padding: var(--space-lg);
    }
  }
</style>
