---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import WhatsAppFloat from '../../components/WhatsAppFloat.astro';
import BlogCard from '../../components/BlogCard.astro';
import { posts } from '../../data/posts';
import { resolveImage } from '../../utils/images';

// Sort posts by date (newest first)
const sortedPosts = [...posts].sort((a, b) =>
  new Date(b.fecha).getTime() - new Date(a.fecha).getTime()
);

// Get unique categories
const categorias = [...new Set(posts.map(p => p.categoria))];
---

<BaseLayout
  title="Blog"
  description="Artículos sobre arqueología, historia y patrimonio del Noroeste Argentino. Quilmes, menhires, Ibatín y más."
>
  <WhatsAppFloat />
  <Header />

  <main>
    <!-- HERO -->
    <section class="hero-blog">
      <div class="wrap text-center">
        <h1>Blog <span class="accent">Mallku</span></h1>
        <p class="hero-lead">
          Historias, descubrimientos y reflexiones sobre la arqueología y el patrimonio del Noroeste Argentino.
        </p>
      </div>
    </section>

    <!-- CATEGORÍAS -->
    <section class="categorias-section">
      <div class="wrap">
        <div class="categorias-list">
          <button class="categoria-btn active" data-categoria="todos">Todos</button>
          {categorias.map((cat) => (
            <button class="categoria-btn" data-categoria={cat}>{cat}</button>
          ))}
        </div>
      </div>
    </section>

    <!-- POSTS -->
    <section class="section section-dark">
      <div class="wrap">
        <div class="blog-grid">
          {sortedPosts.map((post) => (
            <BlogCard
              slug={post.slug}
              titulo={post.titulo}
              excerpt={post.excerpt}
              fecha={post.fecha}
              categoria={post.categoria}
              tiempoLectura={post.tiempoLectura}
              image={resolveImage(post.imagen)}
            />
          ))}
        </div>
      </div>
    </section>

    <!-- CTA -->
    <section class="section section-terracota">
      <div class="wrap text-center">
        <h2 class="section-title">¿Querés vivir la historia en persona?</h2>
        <p class="section-subtitle" style="color: rgba(255,255,255,0.85);">
          Nuestras excursiones te llevan a los sitios que describimos en estos artículos.
        </p>
        <a class="btn" href="/excursiones" style="background: #fff; color: var(--terracota);">
          Ver excursiones
        </a>
      </div>
    </section>
  </main>

  <Footer />
</BaseLayout>

<style>
  .hero-blog {
    padding: 80px 0 40px;
    background:
      radial-gradient(ellipse 80% 50% at 50% 0%, rgba(209, 107, 56, 0.15), transparent),
      var(--color-bg-dark);
  }

  .hero-blog h1 {
    margin: 0 0 20px;
    font-size: clamp(40px, 6vw, 56px);
  }

  .hero-blog .accent {
    color: var(--color-primary);
  }

  .hero-lead {
    font-size: 18px;
    color: rgba(239, 227, 214, 0.8);
    max-width: 55ch;
    margin: 0 auto;
  }

  /* Categorías */
  .categorias-section {
    padding: 24px 0;
    background: var(--color-bg-dark);
    border-bottom: 1px solid var(--color-line-light);
  }

  .categorias-list {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .categoria-btn {
    padding: 10px 20px;
    background: transparent;
    border: 1px solid var(--color-line-light);
    border-radius: 0;
    color: var(--crema);
    font-family: var(--font-display);
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .categoria-btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .categoria-btn.active {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: #fff;
  }

  /* Blog Grid */
  .blog-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-lg);
  }

  @media (max-width: 800px) {
    .blog-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // Simple category filter (client-side)
  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('.categoria-btn');
    const cards = document.querySelectorAll('.blog-grid > a');

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const categoria = btn.getAttribute('data-categoria');

        // Update active button
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Filter cards
        cards.forEach(card => {
          const cardCategoria = card.querySelector('.categoria-tag')?.textContent;
          if (categoria === 'todos' || cardCategoria === categoria) {
            (card as HTMLElement).style.display = 'block';
          } else {
            (card as HTMLElement).style.display = 'none';
          }
        });
      });
    });
  });
</script>
