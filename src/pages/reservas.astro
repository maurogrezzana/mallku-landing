---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import WhatsAppFloat from '../components/WhatsAppFloat.astro';
---

<BaseLayout
  title="Estado de reserva"
  description="Consultá el estado de tu reserva o propuesta de excursión con Mallku."
>
  <WhatsAppFloat />
  <Header />

  <main>
    <section class="confirmacion-hero">
      <div class="wrap text-center">
        <div id="loading-state">
          <div class="loading-spinner"></div>
          <p>Cargando tu reserva...</p>
        </div>

        <!-- Error -->
        <div id="error-state" style="display:none">
          <div class="estado-icon error-icon">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
          </div>
          <h1>No encontramos tu reserva</h1>
          <p id="error-msg">Verificá el número de reserva e intentá nuevamente.</p>
          <a href="/calendario" class="btn btn-primary">Ver calendario</a>
        </div>

        <!-- Fecha fija confirmada -->
        <div id="confirmed-state" style="display:none">
          <div class="estado-icon confirmed-icon">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
          </div>
          <h1 class="confirmed-title">¡Reserva <span class="accent">confirmada</span>!</h1>
          <p class="confirmed-subtitle">Tu lugar está asegurado. Revisá tu email para más detalles.</p>
        </div>

        <!-- Propuesta pendiente -->
        <div id="propuesta-pendiente-state" style="display:none">
          <div class="estado-icon pending-icon">
            <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
          </div>
          <h1>Propuesta <span class="accent">en revisión</span></h1>
          <p class="confirmed-subtitle">Tu propuesta fue recibida. Te contactamos en las próximas 24-48hs para confirmarte.</p>
        </div>

        <!-- Propuesta aprobada -->
        <div id="propuesta-aprobada-state" style="display:none">
          <div class="estado-icon confirmed-icon">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
          </div>
          <h1>¡Propuesta <span class="accent">aprobada</span>!</h1>
          <p class="confirmed-subtitle">Tu fecha personalizada fue confirmada. ¡Ya tenés tu lugar reservado!</p>
        </div>

        <!-- Propuesta rechazada -->
        <div id="propuesta-rechazada-state" style="display:none">
          <div class="estado-icon error-icon">
            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
          </div>
          <h1>Propuesta no disponible</h1>
          <p class="confirmed-subtitle">Lamentablemente no podemos confirmar tu fecha propuesta.</p>
          <p id="motivo-rechazo" class="motivo-texto"></p>
        </div>
      </div>
    </section>

    <!-- Detalles de la reserva -->
    <div id="booking-details" style="display:none">
      <section class="section section-light">
        <div class="wrap detalles-layout">

          <div class="detalle-card">
            <h3>Detalles de tu reserva</h3>
            <div class="detalle-grid">
              <div class="detalle-item">
                <span class="detalle-label">Número de reserva</span>
                <span class="detalle-valor numero-reserva" id="det-numero">—</span>
              </div>
              <div class="detalle-item">
                <span class="detalle-label">Excursión</span>
                <span class="detalle-valor" id="det-excursion">—</span>
              </div>
              <div class="detalle-item" id="det-fecha-wrap">
                <span class="detalle-label">Fecha</span>
                <span class="detalle-valor" id="det-fecha">—</span>
              </div>
              <div class="detalle-item" id="det-propuesta-wrap" style="display:none">
                <span class="detalle-label">Fecha propuesta</span>
                <span class="detalle-valor" id="det-fecha-propuesta">—</span>
              </div>
              <div class="detalle-item">
                <span class="detalle-label">Personas</span>
                <span class="detalle-valor" id="det-personas">—</span>
              </div>
              <div class="detalle-item">
                <span class="detalle-label">Estado</span>
                <span class="detalle-valor" id="det-estado">—</span>
              </div>
              <div class="detalle-item">
                <span class="detalle-label">Nombre</span>
                <span class="detalle-valor" id="det-nombre">—</span>
              </div>
              <div class="detalle-item">
                <span class="detalle-label">Email</span>
                <span class="detalle-valor" id="det-email">—</span>
              </div>
            </div>
          </div>

          <div class="proximos-pasos">
            <div id="pasos-fecha-fija" style="display:none">
              <h3>Próximos pasos</h3>
              <ol class="pasos-list">
                <li>Revisá tu email — enviamos la confirmación con todos los detalles</li>
                <li>Hacé la seña del 30-50% por transferencia bancaria para asegurar tu lugar</li>
                <li>El saldo se abona 48hs antes de la salida</li>
                <li>Te enviamos el punto de encuentro y horario confirmado una semana antes</li>
              </ol>
            </div>

            <div id="pasos-propuesta" style="display:none">
              <h3>¿Qué pasa ahora?</h3>
              <ol class="pasos-list">
                <li>Revisamos tu propuesta y la disponibilidad del guía</li>
                <li>Te contactamos en 24-48hs por email y WhatsApp</li>
                <li>Si aprobamos: te enviamos los detalles de pago para confirmar</li>
                <li>Si no podemos: te sugerimos fechas alternativas</li>
              </ol>
            </div>

            <div class="contacto-directo">
              <p>¿Tenés alguna consulta?</p>
              <a
                href="https://wa.me/5493815702549"
                target="_blank"
                rel="noopener"
                class="btn btn-primary"
              >
                <svg viewBox="0 0 24 24" style="width:18px;height:18px;fill:currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                Hablar con nosotros
              </a>
              <a href="/calendario" class="btn btn-outline" style="margin-top:10px">
                Ver más fechas
              </a>
            </div>
          </div>

        </div>
      </section>
    </div>

  </main>

  <Footer />
</BaseLayout>

<script>
  const API_URL = 'https://mallku-api.vercel.app';

  const params = new URLSearchParams(window.location.search);
  const bookingNumber = params.get('numero');

  const loadingEl = document.getElementById('loading-state') as HTMLElement;

  function hideAll() {
    ['loading-state','error-state','confirmed-state','propuesta-pendiente-state','propuesta-aprobada-state','propuesta-rechazada-state'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });
  }

  function show(id: string) {
    hideAll();
    const el = document.getElementById(id);
    if (el) el.style.display = 'block';
  }

  function populateDetails(booking: any) {
    const excursionTitulo = booking.excursionTitulo || booking.excursionSlug || '—';

    document.getElementById('det-numero')!.textContent = booking.bookingNumber || '—';
    document.getElementById('det-excursion')!.textContent = excursionTitulo;
    document.getElementById('det-personas')!.textContent = `${booking.cantidadPersonas || '—'} persona${booking.cantidadPersonas > 1 ? 's' : ''}`;
    document.getElementById('det-nombre')!.textContent = booking.nombre || '—';
    document.getElementById('det-email')!.textContent = booking.email || '—';

    const tipo = booking.tipo || 'fecha-fija';

    if (tipo === 'personalizada') {
      // Show fecha propuesta row
      const propuestaWrap = document.getElementById('det-propuesta-wrap') as HTMLElement;
      propuestaWrap.style.display = 'flex';
      const fechaWrap = document.getElementById('det-fecha-wrap') as HTMLElement;
      fechaWrap.style.display = 'none';

      if (booking.fechaPropuesta) {
        const fp = new Date(booking.fechaPropuesta);
        document.getElementById('det-fecha-propuesta')!.textContent =
          fp.toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      }

      // Estado propuesta badge
      const estadoPropuesta = booking.estadoPropuesta || 'pendiente';
      const estadoMap: Record<string, string> = {
        pendiente: 'En revisión',
        aprobada: 'Aprobada',
        rechazada: 'No disponible',
      };
      document.getElementById('det-estado')!.textContent = estadoMap[estadoPropuesta] || estadoPropuesta;

      // Show correct state panel
      if (estadoPropuesta === 'pendiente') show('propuesta-pendiente-state');
      else if (estadoPropuesta === 'aprobada') show('propuesta-aprobada-state');
      else if (estadoPropuesta === 'rechazada') {
        show('propuesta-rechazada-state');
        if (booking.motivoRechazo) {
          document.getElementById('motivo-rechazo')!.textContent = booking.motivoRechazo;
        }
      }

      // Show pasos propuesta
      const pasosProp = document.getElementById('pasos-propuesta') as HTMLElement;
      pasosProp.style.display = estadoPropuesta === 'pendiente' ? 'block' : 'none';

    } else {
      // fecha-fija
      if (booking.fecha) {
        const f = new Date(booking.fecha);
        document.getElementById('det-fecha')!.textContent =
          f.toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      }

      const statusMap: Record<string, string> = {
        pending: 'Pendiente de pago',
        confirmed: 'Confirmada',
        paid: 'Pagada',
        completed: 'Completada',
        cancelled: 'Cancelada',
      };
      document.getElementById('det-estado')!.textContent = statusMap[booking.status] || booking.status || '—';

      show('confirmed-state');
      const pasosFija = document.getElementById('pasos-fecha-fija') as HTMLElement;
      pasosFija.style.display = 'block';
    }

    // Show details section
    const detailsEl = document.getElementById('booking-details') as HTMLElement;
    detailsEl.style.display = 'block';
  }

  async function loadBooking() {
    if (!bookingNumber) {
      show('error-state');
      document.getElementById('error-msg')!.textContent = 'No se encontró un número de reserva. Por favor volvé al calendario.';
      return;
    }

    try {
      const res = await fetch(`${API_URL}/api/v1/bookings/${encodeURIComponent(bookingNumber)}`);
      if (!res.ok) {
        show('error-state');
        return;
      }
      const json = await res.json();
      if (!json.success || !json.data) {
        show('error-state');
        return;
      }
      populateDetails(json.data);
    } catch {
      show('error-state');
      document.getElementById('error-msg')!.textContent = 'Error de conexión. Por favor intentá nuevamente o consultanos por WhatsApp.';
    }
  }

  // For propuesta pendiente: poll every 30s to check if it was reviewed
  let pollInterval: ReturnType<typeof setInterval>;

  async function pollPropuestaStatus() {
    if (!bookingNumber) return;
    try {
      const res = await fetch(`${API_URL}/api/v1/bookings/${encodeURIComponent(bookingNumber)}`);
      if (!res.ok) return;
      const json = await res.json();
      if (!json.success || !json.data) return;

      const booking = json.data;
      if (booking.estadoPropuesta && booking.estadoPropuesta !== 'pendiente') {
        clearInterval(pollInterval);
        populateDetails(booking);
      }
    } catch {
      // Silently fail
    }
  }

  loadBooking().then(() => {
    // Only poll if it's a propuesta pendiente
    const propuestaEl = document.getElementById('propuesta-pendiente-state') as HTMLElement;
    if (propuestaEl && propuestaEl.style.display !== 'none') {
      pollInterval = setInterval(pollPropuestaStatus, 30000);
    }
  });
</script>

<style>
  .confirmacion-hero {
    padding: 80px 0 60px;
    background:
      radial-gradient(ellipse 80% 50% at 50% 0%, rgba(209, 107, 56, 0.12), transparent),
      var(--color-bg-dark);
    min-height: 280px;
    display: flex;
    align-items: center;
  }

  .confirmacion-hero .wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }

  /* Loading */
  #loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    color: rgba(239, 227, 214, 0.7);
  }

  .loading-spinner {
    width: 44px;
    height: 44px;
    border: 3px solid rgba(209, 107, 56, 0.2);
    border-top-color: var(--terracota);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* Estado icons */
  .estado-icon {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 8px;
  }

  .estado-icon svg {
    width: 42px;
    height: 42px;
  }

  .confirmed-icon {
    background: rgba(34, 197, 94, 0.15);
  }

  .confirmed-icon svg { fill: #22c55e; }

  .pending-icon {
    background: rgba(245, 158, 11, 0.15);
  }

  .pending-icon svg { fill: #f59e0b; }

  .error-icon {
    background: rgba(239, 68, 68, 0.15);
  }

  .error-icon svg { fill: #ef4444; }

  h1 {
    font-size: clamp(28px, 5vw, 44px);
    margin: 0;
    color: var(--beige);
  }

  .accent { color: var(--terracota); }

  .confirmed-title { color: var(--beige); }

  .confirmed-subtitle {
    font-size: 17px;
    color: rgba(239, 227, 214, 0.75);
    margin: 0;
    max-width: 50ch;
  }

  .motivo-texto {
    font-size: 15px;
    color: rgba(239, 227, 214, 0.6);
    max-width: 50ch;
    background: rgba(239, 68, 68, 0.08);
    border: 1px solid rgba(239, 68, 68, 0.2);
    padding: 12px 20px;
    margin: 0;
    line-height: 1.5;
  }

  /* Detalles */
  .detalles-layout {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: var(--space-xl);
    align-items: start;
    padding-top: var(--space-xl);
    padding-bottom: var(--space-2xl);
  }

  .detalle-card {
    background: #fff;
    border: 1px solid rgba(86, 46, 24, 0.12);
    padding: var(--space-xl);
  }

  .detalle-card h3 {
    margin: 0 0 var(--space-lg);
    color: var(--azul);
    font-size: 20px;
  }

  .detalle-grid {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .detalle-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 10px 0;
    border-bottom: 1px solid rgba(86, 46, 24, 0.08);
    gap: 16px;
  }

  .detalle-item:last-child { border-bottom: none; }

  .detalle-label {
    font-size: 12px;
    font-family: var(--font-display);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: rgba(86, 46, 24, 0.55);
    flex-shrink: 0;
  }

  .detalle-valor {
    font-size: 14px;
    color: var(--azul);
    text-align: right;
    font-weight: 500;
  }

  .numero-reserva {
    font-family: var(--font-display);
    font-size: 13px;
    letter-spacing: 1px;
    color: var(--terracota);
  }

  /* Próximos pasos */
  .proximos-pasos {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .proximos-pasos h3 {
    margin: 0 0 12px;
    font-size: 18px;
    color: var(--azul);
  }

  .pasos-list {
    margin: 0;
    padding-left: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .pasos-list li {
    font-size: 14px;
    color: var(--marron);
    line-height: 1.5;
  }

  .contacto-directo {
    background: var(--azul);
    padding: var(--space-lg);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .contacto-directo p {
    color: rgba(239, 227, 214, 0.8);
    font-size: 15px;
    margin: 0 0 12px;
  }

  .contacto-directo .btn {
    width: 100%;
  }

  @media (max-width: 900px) {
    .detalles-layout {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 600px) {
    .detalle-card {
      padding: var(--space-md);
    }
  }
</style>
