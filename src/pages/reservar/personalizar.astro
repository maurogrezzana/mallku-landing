---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import WhatsAppFloat from '../../components/WhatsAppFloat.astro';
import { excursiones } from '../../data/excursiones';
---

<BaseLayout
  title="Personalizar mi fecha"
  description="¿Ninguna de nuestras fechas te conviene? Proponé tu propia fecha y te confirmamos disponibilidad en 24-48hs."
>
  <WhatsAppFloat />
  <Header />

  <main>
    <section class="personalizar-hero">
      <div class="wrap">
        <nav class="breadcrumb" aria-label="Navegación">
          <a href="/">Inicio</a> <span>›</span>
          <a href="/calendario">Calendario</a> <span>›</span>
          <span>Personalizar fecha</span>
        </nav>
        <h1>Proponé tu <span class="accent">Propia Fecha</span></h1>
        <p class="hero-lead">
          Si ninguna de nuestras fechas te viene bien, elegí cuándo querés ir.<br>
          Te confirmamos disponibilidad en 24-48hs.
        </p>
      </div>
    </section>

    <section class="section section-light">
      <div class="wrap personalizar-layout">

        <!-- Paso 1: Elegir excursión -->
        <div class="paso" id="paso-1">
          <div class="paso-header">
            <span class="paso-numero">1</span>
            <h2>¿Qué excursión te interesa?</h2>
          </div>

          <div class="excursiones-grid">
            {excursiones.map((exc) => (
              <button
                type="button"
                class="excursion-btn"
                data-slug={exc.slug}
                data-nombre={exc.titulo}
                data-duracion={exc.duracion}
                data-salida={exc.salida}
              >
                <div class="exc-nombre">{exc.titulo}</div>
                <div class="exc-meta">
                  <span>{exc.duracion}</span>
                  <span>·</span>
                  <span>{exc.dificultad}</span>
                </div>
                <div class="exc-tag">{exc.tag}</div>
              </button>
            ))}
          </div>
        </div>

        <!-- Paso 2: Ver itinerario -->
        <div class="paso" id="paso-2" style="display:none">
          <div class="paso-header">
            <span class="paso-numero">2</span>
            <h2>Revisá el itinerario</h2>
            <button type="button" class="cambiar-btn" id="btn-cambiar-excursion">Cambiar excursión</button>
          </div>

          <div class="itinerario-seleccionada">
            <h3 id="itinerario-titulo">—</h3>
            <p id="itinerario-descripcion" class="itinerario-desc"></p>
          </div>

          <div class="itinerario-accordion" id="itinerario-items">
            <!-- Populated by JS -->
          </div>

          <div class="proximas-fechas-wrap" id="proximas-fechas-wrap">
            <h4>Próximas fechas publicadas para esta excursión</h4>
            <div class="proximas-fechas" id="proximas-fechas">
              <div class="cargando-fechas">Cargando fechas...</div>
            </div>
            <p class="proximas-note">¿Ninguna te viene bien? Proponé tu fecha abajo.</p>
          </div>

          <button type="button" class="btn btn-primary" id="btn-continuar-paso-3">
            Proponer mi fecha →
          </button>
        </div>

        <!-- Paso 3: Formulario de propuesta -->
        <div class="paso" id="paso-3" style="display:none">
          <div class="paso-header">
            <span class="paso-numero">3</span>
            <h2>Completá tu propuesta</h2>
            <button type="button" class="cambiar-btn" id="btn-volver-paso-2">← Volver</button>
          </div>

          <div class="aviso-propuesta">
            <strong>Importante:</strong> Esta es una propuesta, no una reserva confirmada.
            Te contactamos en 24-48hs para confirmarte disponibilidad.
          </div>

          <form id="personalizar-form" novalidate>
            <div class="form-group">
              <label>Excursión seleccionada</label>
              <input type="text" id="excursion-display" readonly class="input-readonly" />
              <input type="hidden" id="excursionSlug" name="excursionSlug" />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="fechaPropuesta">Fecha que proponés <span class="required">*</span></label>
                <input type="date" id="fechaPropuesta" name="fechaPropuesta" required />
                <span class="input-hint">Mínimo 7 días desde hoy</span>
              </div>
              <div class="form-group">
                <label for="cantidadPersonas">Cantidad de personas <span class="required">*</span></label>
                <select id="cantidadPersonas" name="cantidadPersonas" required>
                  <option value="">— Seleccioná —</option>
                  {[1,2,3,4,5,6,7,8,9,10,11,12].map(n => (
                    <option value={String(n)}>{n} {n === 1 ? 'persona' : 'personas'}</option>
                  ))}
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="nombre">Nombre completo <span class="required">*</span></label>
              <input type="text" id="nombre" name="nombre" placeholder="Ej: Carlos Rodríguez" required autocomplete="name" />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="email">Email <span class="required">*</span></label>
                <input type="email" id="email" name="email" placeholder="tu@email.com" required autocomplete="email" />
              </div>
              <div class="form-group">
                <label for="telefono">Teléfono / WhatsApp <span class="required">*</span></label>
                <input type="tel" id="telefono" name="telefono" placeholder="+54 381 555-0000" required autocomplete="tel" />
              </div>
            </div>

            <div class="form-group">
              <label for="notasCliente">¿Por qué esa fecha? (opcional)</label>
              <textarea id="notasCliente" name="notasCliente" rows="3"
                placeholder="Ej: Solo tenemos disponibilidad esa semana por vacaciones escolares. Somos una familia con dos niños de 10 y 13 años."></textarea>
            </div>

            <div id="form-error" class="form-error" style="display:none" role="alert" aria-live="polite"></div>

            <button type="submit" class="btn btn-primary btn-full" id="submit-btn">
              Enviar propuesta
            </button>

            <p class="form-privacidad">
              Tus datos se usan solo para gestionar tu propuesta y comunicarnos con vos.
              <a href="/politica-de-privacidad">Política de privacidad</a>.
            </p>
          </form>
        </div>

      </div>
    </section>
  </main>

  <Footer />
</BaseLayout>

<script>
  const API_URL = 'https://mallku-api.vercel.app';

  // Excursion data from Astro (passed via data attributes on buttons)
  const excursionBtns = document.querySelectorAll('.excursion-btn') as NodeListOf<HTMLButtonElement>;

  // State
  let selectedSlug = '';

  // Check URL param for pre-selected excursion
  const params = new URLSearchParams(window.location.search);
  const preselectedSlug = params.get('excursion');

  // Paso navigation
  const paso1 = document.getElementById('paso-1') as HTMLElement;
  const paso2 = document.getElementById('paso-2') as HTMLElement;
  const paso3 = document.getElementById('paso-3') as HTMLElement;

  function showPaso(n: number) {
    paso1.style.display = n === 1 ? 'block' : 'none';
    paso2.style.display = n === 2 ? 'block' : 'none';
    paso3.style.display = n === 3 ? 'block' : 'none';
  }

  // Excursion selection
  excursionBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      excursionBtns.forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      selectedSlug = btn.dataset.slug || '';
      selectExcursion(selectedSlug);
    });
  });

  async function selectExcursion(slug: string) {
    selectedSlug = slug;

    // Find button data
    const btn = document.querySelector(`[data-slug="${slug}"]`) as HTMLButtonElement;
    if (!btn) return;

    // Populate paso 2 header
    document.getElementById('itinerario-titulo')!.textContent = btn.dataset.nombre || '';

    // Fetch excursion details from API
    try {
      const res = await fetch(`${API_URL}/api/v1/excursions/${slug}`);
      if (res.ok) {
        const json = await res.json();
        if (json.success && json.data) {
          const exc = json.data;
          document.getElementById('itinerario-descripcion')!.textContent = exc.descripcion || '';

          // Render itinerary accordion
          const container = document.getElementById('itinerario-items') as HTMLElement;
          if (exc.itinerario && Array.isArray(exc.itinerario)) {
            container.innerHTML = exc.itinerario.map((item: any, i: number) => `
              <details class="itinerario-item">
                <summary>
                  <span class="item-orden">${i + 1}</span>
                  <span class="item-titulo">${item.actividad || item.titulo || ''}</span>
                </summary>
                <div class="item-desc">${item.descripcion || ''}</div>
              </details>
            `).join('');
          }
        }
      }
    } catch {
      // Use static data if API fails
      document.getElementById('itinerario-descripcion')!.textContent = btn.dataset.nombre || '';
    }

    // Fetch upcoming dates for this excursion
    loadProximasFechas(slug);

    showPaso(2);
  }

  async function loadProximasFechas(slug: string) {
    const container = document.getElementById('proximas-fechas') as HTMLElement;
    try {
      const res = await fetch(`${API_URL}/api/v1/dates/calendar?excursion=${slug}`);
      if (res.ok) {
        const json = await res.json();
        if (json.success && Array.isArray(json.data) && json.data.length > 0) {
          container.innerHTML = json.data.slice(0, 4).map((d: any) => {
            const fecha = new Date(d.fecha);
            const fechaStr = fecha.toLocaleDateString('es-AR', { day: 'numeric', month: 'long', year: 'numeric' });
            const cupos = d.cuposDisponibles;
            const estado = d.estado;
            let badge = '';
            if (estado === 'completo') badge = '<span class="badge-completo">Completo</span>';
            else if (estado === 'pocos-cupos') badge = `<span class="badge-pocos">¡Solo ${cupos}!</span>`;
            else badge = `<span class="badge-disponible">${cupos} cupos</span>`;
            return `<div class="proxima-fecha-item"><span class="pf-fecha">${fechaStr}</span>${badge}</div>`;
          }).join('');
        } else {
          container.innerHTML = '<p class="no-fechas">No hay fechas publicadas próximamente para esta excursión.</p>';
        }
      }
    } catch {
      container.innerHTML = '<p class="no-fechas">No se pudieron cargar las fechas.</p>';
    }
  }

  // Paso 2 → 3
  document.getElementById('btn-continuar-paso-3')?.addEventListener('click', () => {
    const btn = document.querySelector(`[data-slug="${selectedSlug}"]`) as HTMLButtonElement;
    if (btn) {
      (document.getElementById('excursion-display') as HTMLInputElement).value = btn.dataset.nombre || '';
      (document.getElementById('excursionSlug') as HTMLInputElement).value = selectedSlug;
    }

    // Set min date (today + 7 days)
    const minDate = new Date();
    minDate.setDate(minDate.getDate() + 7);
    const maxDate = new Date();
    maxDate.setMonth(maxDate.getMonth() + 6);
    const dateInput = document.getElementById('fechaPropuesta') as HTMLInputElement;
    dateInput.min = minDate.toISOString().substring(0, 10);
    dateInput.max = maxDate.toISOString().substring(0, 10);

    showPaso(3);
  });

  // Back buttons
  document.getElementById('btn-cambiar-excursion')?.addEventListener('click', () => showPaso(1));
  document.getElementById('btn-volver-paso-2')?.addEventListener('click', () => showPaso(2));

  // Pre-select excursion from URL param
  if (preselectedSlug) {
    const btn = document.querySelector(`[data-slug="${preselectedSlug}"]`) as HTMLButtonElement;
    if (btn) {
      btn.classList.add('selected');
      selectExcursion(preselectedSlug);
    }
  }

  // Form submission
  const form = document.getElementById('personalizar-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const formError = document.getElementById('form-error') as HTMLElement;

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    formError.style.display = 'none';
    submitBtn.disabled = true;
    submitBtn.textContent = 'Enviando propuesta...';

    const formData = new FormData(form);
    const fechaPropuestaVal = formData.get('fechaPropuesta') as string;

    const body = {
      tipo: 'personalizada',
      excursionSlug: formData.get('excursionSlug') as string,
      fechaPropuesta: new Date(fechaPropuestaVal + 'T12:00:00').toISOString(),
      cantidadPersonas: parseInt(formData.get('cantidadPersonas') as string),
      nombreCompleto: formData.get('nombre') as string,
      email: formData.get('email') as string,
      telefono: formData.get('telefono') as string,
      notasCliente: formData.get('notasCliente') as string || undefined,
    };

    if (!body.excursionSlug || !fechaPropuestaVal || !body.cantidadPersonas || !body.nombreCompleto || !body.email || !body.telefono) {
      formError.textContent = 'Por favor completá todos los campos requeridos.';
      formError.style.display = 'block';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Enviar propuesta';
      return;
    }

    try {
      const res = await fetch(`${API_URL}/api/v1/bookings`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      const json = await res.json();

      if (!res.ok || !json.success) {
        formError.textContent = json.message || 'No se pudo enviar la propuesta. Intentá nuevamente.';
        formError.style.display = 'block';
        formError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        submitBtn.disabled = false;
        submitBtn.textContent = 'Enviar propuesta';
        return;
      }

      window.location.href = `/reservas?numero=${encodeURIComponent(json.data.bookingNumber)}`;

    } catch {
      formError.textContent = 'Error de conexión. Por favor intentá nuevamente o consultanos por WhatsApp.';
      formError.style.display = 'block';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Enviar propuesta';
    }
  });
</script>

<style>
  .personalizar-hero {
    padding: 60px 0 40px;
    background:
      radial-gradient(ellipse 80% 50% at 50% 0%, rgba(209, 107, 56, 0.12), transparent),
      var(--color-bg-dark);
  }

  .breadcrumb {
    font-size: 13px;
    color: rgba(239, 227, 214, 0.6);
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 6px;
    flex-wrap: wrap;
  }

  .breadcrumb a {
    color: rgba(239, 227, 214, 0.6);
    text-decoration: none;
  }

  .breadcrumb a:hover { color: var(--beige); }

  .personalizar-hero h1 {
    margin: 0 0 12px;
    font-size: clamp(32px, 5vw, 48px);
  }

  .accent { color: var(--terracota); }

  .hero-lead {
    color: rgba(239, 227, 214, 0.75);
    font-size: 17px;
    margin: 0;
    line-height: 1.6;
  }

  .personalizar-layout {
    max-width: 800px;
    padding-top: var(--space-xl);
    padding-bottom: var(--space-2xl);
  }

  /* Paso */
  .paso {
    margin-bottom: var(--space-xl);
  }

  .paso-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: var(--space-lg);
  }

  .paso-numero {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--terracota);
    color: #fff;
    font-family: var(--font-display);
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .paso-header h2 {
    margin: 0;
    font-size: 24px;
    color: var(--azul);
    flex: 1;
  }

  .cambiar-btn {
    background: none;
    border: 1px solid rgba(86, 46, 24, 0.3);
    color: var(--marron);
    padding: 6px 14px;
    font-size: 13px;
    cursor: pointer;
    font-family: var(--font-body);
    transition: border-color 0.2s;
  }

  .cambiar-btn:hover {
    border-color: var(--terracota);
    color: var(--terracota);
  }

  /* Excursion selection */
  .excursiones-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: var(--space-md);
  }

  .excursion-btn {
    background: #fff;
    border: 2px solid rgba(86, 46, 24, 0.15);
    padding: 20px;
    text-align: left;
    cursor: pointer;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .excursion-btn:hover {
    border-color: var(--terracota);
  }

  .excursion-btn.selected {
    border-color: var(--terracota);
    background: rgba(209, 107, 56, 0.05);
    box-shadow: 0 0 0 2px rgba(209, 107, 56, 0.2);
  }

  .exc-nombre {
    font-family: var(--font-heading);
    font-size: 17px;
    color: var(--azul);
    font-weight: 600;
  }

  .exc-meta {
    font-size: 12px;
    color: var(--marron);
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .exc-tag {
    font-size: 11px;
    font-family: var(--font-display);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--terracota);
    margin-top: 4px;
  }

  /* Itinerario */
  .itinerario-seleccionada {
    margin-bottom: var(--space-lg);
  }

  .itinerario-seleccionada h3 {
    margin: 0 0 8px;
    font-size: 22px;
    color: var(--azul);
  }

  .itinerario-desc {
    color: var(--marron);
    font-size: 15px;
    margin: 0;
    line-height: 1.65;
  }

  .itinerario-accordion {
    display: flex;
    flex-direction: column;
    gap: 2px;
    margin-bottom: var(--space-lg);
  }

  .itinerario-item {
    border: 1px solid rgba(86, 46, 24, 0.12);
    background: #fff;
  }

  .itinerario-item summary {
    padding: 14px 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    list-style: none;
    color: var(--azul);
    font-size: 15px;
    user-select: none;
  }

  .itinerario-item summary::-webkit-details-marker { display: none; }

  .itinerario-item[open] summary {
    border-bottom: 1px solid rgba(86, 46, 24, 0.1);
  }

  .item-orden {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--terracota);
    color: #fff;
    font-size: 11px;
    font-family: var(--font-display);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .item-titulo {
    font-weight: 600;
    font-family: var(--font-display);
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .item-desc {
    padding: 14px 16px 14px 52px;
    font-size: 14px;
    color: var(--marron);
    line-height: 1.65;
  }

  /* Próximas fechas */
  .proximas-fechas-wrap {
    margin-bottom: var(--space-lg);
    padding: var(--space-md);
    background: rgba(6, 27, 56, 0.04);
    border: 1px solid rgba(86, 46, 24, 0.1);
  }

  .proximas-fechas-wrap h4 {
    margin: 0 0 12px;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--azul);
  }

  .proximas-fechas {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 10px;
  }

  .proxima-fecha-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: #fff;
    border: 1px solid rgba(86, 46, 24, 0.1);
    font-size: 14px;
    color: var(--azul);
  }

  .pf-fecha { font-weight: 500; }

  .badge-disponible {
    font-size: 11px;
    padding: 2px 8px;
    background: rgba(34, 197, 94, 0.12);
    color: #16a34a;
    font-family: var(--font-display);
    text-transform: uppercase;
  }

  .badge-pocos {
    font-size: 11px;
    padding: 2px 8px;
    background: rgba(245, 158, 11, 0.15);
    color: #b45309;
    font-family: var(--font-display);
    text-transform: uppercase;
  }

  .badge-completo {
    font-size: 11px;
    padding: 2px 8px;
    background: rgba(107, 114, 128, 0.12);
    color: #6b7280;
    font-family: var(--font-display);
    text-transform: uppercase;
  }

  .cargando-fechas, .no-fechas {
    font-size: 13px;
    color: var(--marron);
    font-style: italic;
  }

  .proximas-note {
    font-size: 13px;
    color: var(--terracota);
    margin: 0;
    font-style: italic;
  }

  /* Aviso */
  .aviso-propuesta {
    background: rgba(245, 158, 11, 0.1);
    border-left: 3px solid #f59e0b;
    padding: 12px 16px;
    font-size: 14px;
    color: var(--marron);
    margin-bottom: var(--space-lg);
    line-height: 1.5;
  }

  /* Form (shared with reservar.astro) */
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: var(--space-md);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-md);
  }

  label {
    font-size: 13px;
    font-family: var(--font-display);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--azul);
  }

  .required { color: var(--terracota); }

  input, select, textarea {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid rgba(86, 46, 24, 0.25);
    border-radius: 0;
    font-family: var(--font-body);
    font-size: 15px;
    color: var(--azul);
    background: #fff;
    transition: border-color 0.2s ease;
    -webkit-appearance: none;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--terracota);
  }

  .input-readonly {
    background: rgba(86, 46, 24, 0.04);
    color: var(--marron);
  }

  .input-hint {
    font-size: 11px;
    color: rgba(86, 46, 24, 0.5);
    margin-top: 2px;
  }

  textarea {
    resize: vertical;
    min-height: 90px;
  }

  .form-error {
    background: rgba(220, 38, 38, 0.08);
    border: 1px solid rgba(220, 38, 38, 0.3);
    color: #dc2626;
    padding: 12px 16px;
    font-size: 14px;
    margin-bottom: var(--space-md);
  }

  .form-privacidad {
    font-size: 12px;
    color: rgba(86, 46, 24, 0.6);
    margin-top: var(--space-md);
    text-align: center;
  }

  .form-privacidad a {
    color: var(--terracota);
    text-decoration: underline;
  }

  @media (max-width: 600px) {
    .excursiones-grid {
      grid-template-columns: 1fr;
    }

    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>
